Possible Causes
Schema mismatch or version drift: Your backend TypeScript code likely uses a strict interface or schema to parse the AI response (e.g., a zod or yup schema, or a TypeScript interface check), and even a small change in property names or types can cause this.

Field omission or addition: If choices[*].rollPurpose is conditionally present, or if storyImpact is of unexpected type ('major' vs 'high', for example), your schema might be rejecting it.

Deserialization logic error: A JSON.parse() or equivalent might be wrapping the already-parsed response again, or a validator might not be forgiving of optional fields.

Recommended Fixes
✅ 1. Check the schema/interface
Locate your schema in something like:

ts
Copy
Edit
interface StoryResponse {
  narrative: string;
  location: string;
  storyProgression: {
    mainPlotAdvancement: string;
    consequencesShown: string;
    threadsResolved: string[];
    newThreads: string[];
  };
  choices: Choice[];
}

interface Choice {
  action: string;
  description: string;
  requiresDiceRoll: boolean;
  diceType?: string;
  rollDC?: number;
  abilityType?: string;
  rollModifier?: number;
  rollPurpose?: string;
  storyImpact: string;
}
Ensure:

Fields like rollPurpose, diceType, etc. are optional if requiresDiceRoll is false.

Strings like "major" or "minor" in storyImpact are permitted.

✅ 2. Add defensive parsing
Temporarily log or safely coerce bad payloads:

ts
Copy
Edit
try {
  const parsed = JSON.parse(openaiRaw);
  if (!parsed.narrative || !parsed.storyProgression || !Array.isArray(parsed.choices)) {
    throw new Error("Invalid story response format");
  }
  return parsed;
} catch (e) {
  console.error("Failed to parse OpenAI response", openaiRaw);
  throw e;
}
✅ 3. Verify AI prompt & template stability
Ensure your prompt template isn't subtly generating different JSON keys. Consider wrapping generation in markdown code blocks:

text
Copy
Edit
Respond only in the following strict JSON format:
```json
{
  "narrative": "...",
  "location": "...",
  "storyProgression": {
    ...
  },
  "choices": [...]
}
yaml
Copy
Edit
